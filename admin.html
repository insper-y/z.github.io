<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>后台数据管理</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  body {
    background: #f8f9fa;
    padding: 16px;
    -webkit-tap-highlight-color: transparent;
  }
  h1 {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #1d2129;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  .search-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 14px;
    border-bottom: 1px solid #f0f0f0;
  }
  .search-bar input {
    flex: 1;
    min-width: 140px;
    height: 44px;
    padding: 0 12px;
    border: 1px solid #e5e6eb;
    border-radius: 8px;
    font-size: 15px;
    background: #f7f8fa;
  }
  .btn {
    height: 42px;
    padding: 0 14px;
    border-radius: 8px;
    border: 1px solid #e5e6eb;
    background: #fff;
    font-size: 15px;
  }
  .btn.primary {
    background: #1677ff;
    color: #fff;
    border-color: #1677ff;
  }
  .btn.danger {
    background: #ff4d4f;
    color: #fff;
    border-color: #ff4d4f;
  }
  .action-bar {
    display: flex;
    gap: 8px;
    padding: 12px 14px;
    border-bottom: 1px solid #f0f0f0;
  }
  .table-box {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table {
    width: 100%;
    min-width: 600px;
    border-collapse: collapse;
  }
  th, td {
    padding: 12px 8px;
    text-align: left;
    font-size: 14px;
    border-bottom: 1px solid #f0f0f0;
  }
  th {
    background: #fafafa;
    color: #86909c;
  }
  .opt-btn {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 13px;
    margin-right: 4px;
    border: none;
    color: #fff;
  }
  .edit {
    background: #1677ff;
  }
  .del {
    background: #ff4d4f;
  }

  /* 底部弹窗 */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.45);
    justify-content: center;
    align-items: flex-end;
  }
  .modal-body {
    background: #fff;
    width: 100%;
    border-radius: 12px 12px 0 0;
    padding: 20px;
  }
  .modal-body input {
    width: 100%;
    height: 46px;
    margin: 8px 0;
    padding: 0 12px;
    border: 1px solid #e5e6eb;
    border-radius: 8px;
    font-size: 16px;
  }
  .modal-btns {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }
  .modal-btns button {
    flex: 1;
    height: 46px;
    border-radius: 8px;
    font-size: 16px;
  }
</style>
</head>

<body>
<h1>后台数据管理</h1>
<div class="card">
  <div class="search-bar">
    <input id="kw" placeholder="搜索关键词">
    <button class="btn" onclick="searchData()">查询</button>
    <button class="btn" onclick="toggleTable()">隐藏/显示</button>
  </div>

  <div class="action-bar">
    <button class="btn primary" onclick="showAdd()">新建</button>
    <button class="btn" onclick="logout()">退出登录</button>
  </div>

  <div id="tableArea" class="table-box">
    <table>
      <thead>
        <tr>
          <th>序号</th>
          <th>分销软件</th>
          <th>微信账号</th>
          <th>软件账号</th>
          <th>微信备注</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- 新增/编辑弹窗 -->
<div class="modal" id="editModal">
  <div class="modal-body">
    <h3 id="modalTitle">新建数据</h3>
    <input type="hidden" id="rowId">
    <input id="software" placeholder="分销软件">
    <input id="wechatAccount" placeholder="微信账号">
    <input id="softAccount" placeholder="软件账号">
    <input id="wechatRemark" placeholder="微信备注名">
    <div class="modal-btns">
      <button class="btn primary" onclick="saveData()">保存</button>
      <button class="btn" onclick="closeModal()">取消</button>
    </div>
  </div>
</div>

<script>
// ========== 已修改为你的后端地址 ==========
const VM_IP = "192.168.1.55"

let currentEditId = null

window.onload = searchData

// 搜索
async function searchData() {
  const kw = document.getElementById('kw').value
  const r = await fetch(`http://${VM_IP}:3000/api/getData?keyword=${kw}`)
  const res = await r.json()
  const list = res.data || []
  const html = list.map((item,i) => `
  <tr>
    <td>${i+1}</td>
    <td>${item.software||'-'}</td>
    <td>${item.wechat_account||'-'}</td>
    <td>${item.soft_account||'-'}</td>
    <td>${item.wechat_remark||'-'}</td>
    <td>
      <button class="opt-btn edit" onclick="editData(${item.id})">编辑</button>
      <button class="opt-btn del" onclick="delData(${item.id})">删除</button>
    </td>
  </tr>
  `).join('')
  document.getElementById('tableBody').innerHTML = html
}

// 显示新增
function showAdd() {
  currentEditId = null
  document.getElementById('modalTitle').innerText = "新建数据"
  document.getElementById('rowId').value = ""
  document.getElementById('software').value = ""
  document.getElementById('wechatAccount').value = ""
  document.getElementById('softAccount').value = ""
  document.getElementById('wechatRemark').value = ""
  document.getElementById('editModal').style.display = "flex"
}

// 编辑
async function editData(id) {
  currentEditId = id
  document.getElementById('modalTitle').innerText = "编辑数据"
  const r = await fetch(`http://${VM_IP}:3000/api/getDataById?id=${id}`)
  const res = await r.json()
  const d = res.data
  document.getElementById('rowId').value = d.id
  document.getElementById('software').value = d.software || ""
  document.getElementById('wechatAccount').value = d.wechat_account || ""
  document.getElementById('softAccount').value = d.soft_account || ""
  document.getElementById('wechatRemark').value = d.wechat_remark || ""
  document.getElementById('editModal').style.display = "flex"
}

// 保存（新增/编辑通用）
async function saveData() {
  const id = document.getElementById('rowId').value
  const data = {
    software: document.getElementById('software').value,
    wechatAccount: document.getElementById('wechatAccount').value,
    softAccount: document.getElementById('softAccount').value,
    wechatRemark: document.getElementById('wechatRemark').value
  }
  const url = id ? `http://${VM_IP}:3000/api/updateData?id=${id}` : `http://${VM_IP}:3000/api/addData`
  const r = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  })
  const res = await r.json()
  if(res.code === 200) {
    closeModal()
    searchData()
    alert("保存成功")
  } else {
    alert("保存失败")
  }
}

// 删除（加强版：确认）
async function delData(id) {
  if(!confirm("确定要删除这条数据吗？")) return
  const r = await fetch(`http://${VM_IP}:3000/api/delData?id=${id}`)
  const res = await r.json()
  if(res.code === 200) {
    searchData()
    alert("删除成功")
  } else {
    alert("删除失败")
  }
}

// 关闭弹窗
function closeModal() {
  document.getElementById('editModal').style.display = "none"
}

// 隐藏表格
function toggleTable() {
  const area = document.getElementById('tableArea')
  area.style.display = area.style.display === "none" ? "block" : "none"
}

// 退出
function logout() {
  window.location.href = "index.html"
}
</script>
</body>
</html>
